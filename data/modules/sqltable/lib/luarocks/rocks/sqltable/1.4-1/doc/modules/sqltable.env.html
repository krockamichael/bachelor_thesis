<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>SqlTable API Documentation</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>sqltable</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#Functions">Functions</a></li>
<li><a href="#Tables">Tables</a></li>
<li><a href="#Fields">Fields</a></li>
</ul>


<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/sqltable.html">sqltable</a></li>
  <li><strong>sqltable.env</strong></li>
  <li><a href="../modules/sqltable.pool.html">sqltable.pool</a></li>
  <li><a href="../modules/sqltable.table.html">sqltable.table</a></li>
  <li><a href="../modules/sqltable.connection.html">sqltable.connection</a></li>
</ul>

</div>

<div id="content">

<h1>Module <code>sqltable.env</code></h1>
<p>Methods for the Environment object: the top level user API
 to SqlTable.</p>
<p></p>


<h2><a href="#Functions">Functions</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.connections">_sqltable_env.connections (this)</a></td>
	<td class="summary">Returns how many connections SqlTable has open
 to the database.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.close">_sqltable_env.close (this)</a></td>
	<td class="summary">Shuts down this environment.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.reset">_sqltable_env.reset (this)</a></td>
	<td class="summary">Reset the environment: leave the environment open, but close
 all existing connections and open new ones for future calls.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.setup_hook">_sqltable_env.setup_hook (this, fcn)</a></td>
	<td class="summary">Provide a setup hook for new database connections that are opened,
 to configure any variables/PRAGMA options/etc that may be needed.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.exec">_sqltable_env.exec (this, query[, values[, callback]])</a></td>
	<td class="summary">Manually execute a database query.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.select">_sqltable_env.select ()</a></td>
	<td class="summary">Manually perform a select statement.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.insert">_sqltable_env.insert ()</a></td>
	<td class="summary">Manually perform  an insert statement.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.update">_sqltable_env.update ()</a></td>
	<td class="summary">Manually perform  an update statement.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.delete">_sqltable_env.delete ()</a></td>
	<td class="summary">Manually perform  a delete statement.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.count">_sqltable_env.count (tbl[, clause[, ...]])</a></td>
	<td class="summary">Execute a select that counts rows.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.version">_sqltable_env.version (this)</a></td>
	<td class="summary">Returns a version string identifying the version of the
 underlying database.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.all_rows">_sqltable_env.all_rows (tbl)</a></td>
	<td class="summary">Execute a select all rows, returning an iterator.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.where">_sqltable_env.where (tbl[, clause[, ...]])</a></td>
	<td class="summary">Execute a select, as limited by a where clause, returning an
 iterator.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.last_insert_id">_sqltable_env.last_insert_id (tbl)</a></td>
	<td class="summary">Retrieve the primary key of the last row that was inserted.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.placeholder">_sqltable_env.placeholder (this[, nth])</a></td>
	<td class="summary">Writes a placeholder value for use in where statements.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.debugging">_sqltable_env.debugging (this, fcn)</a></td>
	<td class="summary">Apply a debugging hook to this environment.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.clone">_sqltable_env.clone (tbl, where, ...)</a></td>
	<td class="summary">Slurps the result set of an entire query into memory so that normal
 pairs() can work.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.iclone">_sqltable_env.iclone (tbl, where, ...)</a></td>
	<td class="summary">Slurps the result set of an entire query into memory so that normal
 ipairs() can work.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.begin_transaction">_sqltable_env.begin_transaction (this, tbl)</a></td>
	<td class="summary">Start a consistant transaction on a table.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.commit">_sqltable_env.commit (this, tbl)</a></td>
	<td class="summary">Commit a table's transaction.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.rollback">_sqltable_env.rollback (this, tbl)</a></td>
	<td class="summary">Rollback a table's transaction
<p> All changes will be reverted back to when begin_transaction was
 run.</td>
	</tr>
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.open_table">_sqltable_env.open_table (this, params)</a></td>
	<td class="summary">Open a proxy table to a database table.</td>
	</tr>
</table>
<h2><a href="#Tables">Tables</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#TableParameters">TableParameters</a></td>
	<td class="summary">Arguments for opening a table.</td>
	</tr>
</table>
<h2><a href="#Fields">Fields</a></h2>
<table class="function_list">
	<tr>
	<td class="name" nowrap><a href="#_sqltable_env.next">_sqltable_env.next</a></td>
	<td class="summary">A 'magic' value: when inserting new rows with auto incrementing
 primary keys, we don't have a key yet.</td>
	</tr>
</table>

<br/>
<br/>


    <h2 class="section-header "><a name="Functions"></a>Functions</h2>

    <dl class="function">
    <dt>
    <a name = "_sqltable_env.connections"></a>
    <strong>_sqltable_env.connections (this)</strong>
    </dt>
    <dd>
    Returns how many connections SqlTable has open
 to the database.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment object
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Number of existant connections
    </ol>




</dd>
    <dt>
    <a name = "_sqltable_env.close"></a>
    <strong>_sqltable_env.close (this)</strong>
    </dt>
    <dd>
    Shuts down this environment.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment object being closed
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Nothing.
    </ol>




</dd>
    <dt>
    <a name = "_sqltable_env.reset"></a>
    <strong>_sqltable_env.reset (this)</strong>
    </dt>
    <dd>
    Reset the environment: leave the environment open, but close
 all existing connections and open new ones for future calls.
<p> This method comes in handy should your Lua script fork into a second
 process.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment object being reset
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Nothing.
    </ol>




</dd>
    <dt>
    <a name = "_sqltable_env.setup_hook"></a>
    <strong>_sqltable_env.setup_hook (this, fcn)</strong>
    </dt>
    <dd>
    Provide a setup hook for new database connections that are opened,
 to configure any variables/PRAGMA options/etc that may be needed.
<p> The pool will be reset once a hook is set, thus closing all
 open connections and reconnecting.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment object being reset
        </li>
        <li><span class="parameter">fcn</span>
         Function to implement connection setup
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Nothing.
    </ol>




</dd>
    <dt>
    <a name = "_sqltable_env.exec"></a>
    <strong>_sqltable_env.exec (this, query[, values[, callback]])</strong>
    </dt>
    <dd>
    Manually execute a database query.
<p> The arguments returned to the callback function are raw LuaDBI
 Userdata. See documentation for LuaDBI at
 http://code.google.com/p/luadbi/w/list for API details.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment object
        </li>
        <li><span class="parameter">query</span>
         Text of SQL query to execute
        </li>
        <li><span class="parameter">values</span>
         Table of values to bind to the query (if needed)
         (<em>optional</em>)
        </li>
        <li><span class="parameter">callback</span>
         Function that is called to handle returned data
         (<em>optional</em>)
        </li>
    </ul>




    <h3>Usage:</h3>
    <ul>
        <pre class="example">t:exec( <span class="string">"select name from t_employees where where title = $1"</span>, { <span class="string">'Programmer'</span> },
	<span class="keyword">function</span>( connection, statement )
		<span class="keyword">local</span> row = <span class="keyword">true</span>

		<span class="keyword">while</span> row <span class="keyword">do</span>
			row = statement:fetch(<span class="keyword">true</span>)
			do_stuff(row)
		<span class="keyword">end</span>
	<span class="keyword">end</span>
)</pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.select"></a>
    <strong>_sqltable_env.select ()</strong>
    </dt>
    <dd>
    Manually perform a select statement.







</dd>
    <dt>
    <a name = "_sqltable_env.insert"></a>
    <strong>_sqltable_env.insert ()</strong>
    </dt>
    <dd>
    Manually perform  an insert statement.







</dd>
    <dt>
    <a name = "_sqltable_env.update"></a>
    <strong>_sqltable_env.update ()</strong>
    </dt>
    <dd>
    Manually perform  an update statement.







</dd>
    <dt>
    <a name = "_sqltable_env.delete"></a>
    <strong>_sqltable_env.delete ()</strong>
    </dt>
    <dd>
    Manually perform  a delete statement.







</dd>
    <dt>
    <a name = "_sqltable_env.count"></a>
    <strong>_sqltable_env.count (tbl[, clause[, ...]])</strong>
    </dt>
    <dd>
    Execute a select that counts rows.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">tbl</span>
         Table being row counted
        </li>
        <li><span class="parameter">clause</span>
         Optional where clause
         (<em>optional</em>)
        </li>
        <li><span class="parameter">...</span>
         Optional bound parameters for where clause
         (<em>optional</em>)
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Integer number of rows
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">total_employees = env.count( t_employees )
programmers = env.count( t_employees, <span class="string">"where title = $1"</span>, <span class="string">'Programmer'</span> )</pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.version"></a>
    <strong>_sqltable_env.version (this)</strong>
    </dt>
    <dd>
    Returns a version string identifying the version of the
 underlying database.
<p> Please note that the exact format of the returned data may vary
 from database to database.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>

        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        String containing version information
    </ol>




</dd>
    <dt>
    <a name = "_sqltable_env.all_rows"></a>
    <strong>_sqltable_env.all_rows (tbl)</strong>
    </dt>
    <dd>
    Execute a select all rows, returning an iterator.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">tbl</span>
         Table to select from
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Iterator function similar in usage to pairs().
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example"><span class="keyword">for</span> id, employee <span class="keyword">in</span> env.all_rows( t_employees ) <span class="keyword">do</span>
<span class="global">print</span>(id, employee.name)
<span class="keyword">end</span></pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.where"></a>
    <strong>_sqltable_env.where (tbl[, clause[, ...]])</strong>
    </dt>
    <dd>
    Execute a select, as limited by a where clause, returning an
 iterator.  Identical to all_rows() except permits a where clause.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">tbl</span>
         Table to select from
        </li>
        <li><span class="parameter">clause</span>
         Optional where clause
         (<em>optional</em>)
        </li>
        <li><span class="parameter">...</span>
         Optional bound parameters for where clause
         (<em>optional</em>)
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Iterator function similar in usage to pairs().
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example"><span class="keyword">for</span> id, employee <span class="keyword">in</span> env.where( t_employees, <span class="string">"title = $1"</span>, <span class="string">'Programmer'</span> ) <span class="keyword">do</span>
<span class="global">print</span>(id, employee.name)
<span class="keyword">end</span></pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.last_insert_id"></a>
    <strong>_sqltable_env.last_insert_id (tbl)</strong>
    </dt>
    <dd>
    Retrieve the primary key of the last row that was inserted.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">tbl</span>
         Table object that last query was performed on
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Primary key of last insert.
    </ol>


    <h3>See also:</h3>
    <ul>
         <a href="../modules/sqltable.env.html#_sqltable_env.next">_sqltable_env.next</a>
    </ul>

    <h3>Usage:</h3>
    <ul>
        <pre class="example">t_employees[ sqltable.<span class="global">next</span> ] = { name = <span class="string">'Alice'</span>, title = <span class="string">'Programmer'</span> }
alice_id = env.last_insert_id( t_employees )</pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.placeholder"></a>
    <strong>_sqltable_env.placeholder (this[, nth])</strong>
    </dt>
    <dd>
    Writes a placeholder value for use in where statements.  Helps make
 manually crafted queries more portable across databases.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment object
        </li>
        <li><span class="parameter">nth</span>
         Specify that this is the n-th placeholder in this
				query (needed by some database engines)

         (<em>optional</em>)
        </li>
    </ul>




    <h3>Usage:</h3>
    <ul>
        <pre class="example">sql = <span class="string">"where column = "</span> .. env:placeholder(<span class="number">1</span>)
<span class="comment">-- "where column = $1" for PostgreSQL
</span><span class="comment">-- "where column = ?" for MySQL</span></pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.debugging"></a>
    <strong>_sqltable_env.debugging (this, fcn)</strong>
    </dt>
    <dd>
    Apply a debugging hook to this environment.  Any SQL call made will
 be passed to the function, along with a table of any bound
 parameters placed as part of the call.
<p> The hook is called before the code is compiled, so the given callback
 function will be called just before an error is raised.
<p> The hook can be disabled by calling this method again with no
 arguments.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment object
        </li>
        <li><span class="parameter">fcn</span>
         Debugging function
        </li>
    </ul>




    <h3>Usage:</h3>
    <ul>
        <pre class="example"><span class="keyword">function</span> sql_debug( q, args )
<span class="global">print</span>(q)
<span class="keyword">for</span> k, v <span class="keyword">in</span> <span class="global">pairs</span>(args) <span class="keyword">do</span>
	<span class="global">print</span>(k, <span class="string">'"'</span>..<span class="global">tostring</span>(v)..<span class="string">'"'</span>)
<span class="keyword">end</span>
<span class="keyword">end</span>

db.env:debugging( sql_debug )</pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.clone"></a>
    <strong>_sqltable_env.clone (tbl, where, ...)</strong>
    </dt>
    <dd>
    Slurps the result set of an entire query into memory so that normal
 pairs() can work.  The key is chosen from the table's specified key
 column.
<p> THIS IS NOT VERY PERFORMANT WHEN USED WITH LARGE TABLES.
 Use caution.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">tbl</span>
         Table object to clone
        </li>
        <li><span class="parameter">where</span>
         Optional where clause
        </li>
        <li><span class="parameter">...</span>
         Parameters to where clause
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Table of data as returned by select
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">programmers = env.clone( t_employees, <span class="string">"where title = $1"</span>, <span class="string">'Programmer'</span> )
all_employees = env.clone( t_employees )

<span class="keyword">for</span> name, title <span class="keyword">in</span> <span class="global">pairs</span>(all_employees) <span class="keyword">do</span>
<span class="global">print</span>(name, title)
<span class="keyword">end</span></pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.iclone"></a>
    <strong>_sqltable_env.iclone (tbl, where, ...)</strong>
    </dt>
    <dd>
    Slurps the result set of an entire query into memory so that normal
 ipairs() can work.  The key starts at one and increments per row,
 forming a standard Lua array.
<p> THIS IS NOT VERY PERFORMANT WHEN USED WITH LARGE TABLES.
 Use caution.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">tbl</span>
         Table object to clone
        </li>
        <li><span class="parameter">where</span>
         Optional where clause
        </li>
        <li><span class="parameter">...</span>
         Parameters to where clause
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Table of data as returned by select
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">programmers = env.iclone( t_employees, <span class="string">"where title = $1"</span>, <span class="string">'Programmer'</span> )
all_employees = env.iclone( t_employees )

<span class="keyword">for</span> employee_id, name <span class="keyword">in</span> <span class="global">ipairs</span>(all_employees) <span class="keyword">do</span>
<span class="global">print</span>(employee_id, name)
<span class="keyword">end</span></pre>
    </ul>

</dd>
    <dt>
    <a name = "_sqltable_env.begin_transaction"></a>
    <strong>_sqltable_env.begin_transaction (this, tbl)</strong>
    </dt>
    <dd>
    Start a consistant transaction on a table.
<p> The table will be locked to a single SQL connection with
 autocommit mode disabled and a new transaction started.
 You will need to call 'commit' or 'rollback' before the table
 is garbage collected, or a SQL connection will be leaked.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         SqlTable environment
        </li>
        <li><span class="parameter">tbl</span>
         Table transaction is starting on
        </li>
    </ul>





</dd>
    <dt>
    <a name = "_sqltable_env.commit"></a>
    <strong>_sqltable_env.commit (this, tbl)</strong>
    </dt>
    <dd>
    Commit a table's transaction.
<p> All changes to the table will be saved. The SQL connection will be
 returned to the pool and set back to autocommit mode.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         SqlTable environment
        </li>
        <li><span class="parameter">tbl</span>
         Table to commit to transaction on
        </li>
    </ul>





</dd>
    <dt>
    <a name = "_sqltable_env.rollback"></a>
    <strong>_sqltable_env.rollback (this, tbl)</strong>
    </dt>
    <dd>
    Rollback a table's transaction
<p> All changes will be reverted back to when begin_transaction was
 run.  The SQL connection will be returned to the pool and set back
 to autocommit mode.



    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         SqlTable environment
        </li>
        <li><span class="parameter">tbl</span>
         Table to rollback transaction on
        </li>
    </ul>





</dd>
    <dt>
    <a name = "_sqltable_env.open_table"></a>
    <strong>_sqltable_env.open_table (this, params)</strong>
    </dt>
    <dd>
    Open a proxy table to a database table.


    <h3>Parameters:</h3>
    <ul>
        <li><span class="parameter">this</span>
         Environment Object
        </li>
        <li><span class="parameter">params</span>
         <a href="../modules/sqltable.env.html#TableParameters">TableParameters</a>
        </li>
    </ul>

    <h3>Returns:</h3>
    <ol>

        Proxy table object
    </ol>



    <h3>Usage:</h3>
    <ul>
        <pre class="example">t_employees = <span class="global">assert</span>(env:open_table{
	name = <span class="string">'employees'</span>,
	key = <span class="string">'employee_id'</span>
})</pre>
    </ul>

</dd>
</dl>
    <h2 class="section-header "><a name="Tables"></a>Tables</h2>

    <dl class="function">
    <dt>
    <a name = "TableParameters"></a>
    <strong>TableParameters</strong>
    </dt>
    <dd>
    Arguments for opening a table.


    <h3>Fields:</h3>
    <ul>
        <li><span class="parameter">name</span>
         Name of table, in database
        </li>
        <li><span class="parameter">key</span>
         Primary key of table
        </li>
        <li><span class="parameter">vendor</span>
         Table of database-specific parameters
        </li>
        <li><span class="parameter">readonly</span>
         If set to true, updates, inserts, and deletes
		will be disabled.
        </li>
    </ul>





</dd>
</dl>
    <h2 class="section-header "><a name="Fields"></a>Fields</h2>

    <dl class="function">
    <dt>
    <a name = "_sqltable_env.next"></a>
    <strong>_sqltable_env.next</strong>
    </dt>
    <dd>
    A 'magic' value: when inserting new rows with auto incrementing
 primary keys, we don't have a key yet.
<p> Using this value as a key indicates to SqlTable that a new row is
 being inserted, with the primary key to be determined by the
 database.






    <h3>See also:</h3>
    <ul>
         <a href="../modules/sqltable.env.html#_sqltable_env.last_insert_id">_sqltable_env.last_insert_id</a>
    </ul>


</dd>
</dl>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2017-11-07 20:58:40 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
